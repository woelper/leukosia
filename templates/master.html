<!DOCTYPE html>
<html lang="de">
  <head>
	  
    <meta charset="utf-8">
    <title>leukosia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <!-- Le styles -->
    <link href="{{STATIC_URL}}ext/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/style.css" />

  </head>

  <body>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				
					<div class="pull-left">
						<img src="{{STATIC_URL}}img/logo_4_w.png">
					</div>
					
					{% if page != "login" %}
					<p class="navbar-text pull-right">
						logged in as <a class="navbar-link" href="#">username</a>
					</p>
					{% endif%}
					<ul class="nav" id="nav">
                    </ul>
			</div>
		</div>
	</div> <!-- /navbar -->
	
	 <div class="container-fluid">
		<div class="row-fluid">
			<div class="content content-left span9" id="content">
				{%block content%}
				{% endblock %}
			</div> <!-- /content-left -->
			{% if page != "login" %}
			<div class="span3 content-right">
					<h3>...Player...</h3>
					<br>
					<hr>
					<form action="" method="post" onsubmit="push_chat();return false;">
						<div class="input-append">
						  <input id="chatcontent" name="chatcontent" type="text">
						  <button id="chatbutton" class="btn" type="submit">Chat</button>
						</div>
					</form>
					<div id="chat">Chat l√§dt...
					</div>
			</div> <!-- /content-right -->
			{% endif %}
		</div> <!-- /row fluid -->
	</div> <!-- /fluid container -->


	{% if page != "login" %}
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="{{STATIC_URL}}ext/bootstrap/js/bootstrap.js"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    
    
    <script type="text/javascript">
		
	var html = "";
	var last_artist = "";
	var last_album = "";
	var cur_artist;
	var cur_album;
	var songupdater = false;
	
	
	<!-- Start -->
	$(document).ready(function () {
		render_stationoverview ();
		}
	);
	<!-- Update the Chat -->
	$(document).ready(function () {
		update_chat();
		setInterval(update_chat,5000);
		}
	);

	
	function render_stationoverview () {
		$('#content').html("loading...");
		$.get('/stationoverview')
		.done(function(data) {
			if (songupdater) {
				clearInterval(songupdater);
				}
			$('#content').html(data);
			navhtml = '';
			$('#nav').html(navhtml);
			
			}
		);
	}
	
	function render_stationdetails (station_port) {
			last_artist = "";
			last_album = "";
			$('#content').html("loading...");
			$.get('/stationdetails',{'station_port':station_port})
			.done(function(data) {
				$('#content').html(data);
				navhtml = '<li onclick="render_stationoverview()" style="cursor:pointer;"><a>Overview</a></li>'+
							'<li class="divider-vertical"></li>'+
							'<li onclick="previous()" style="cursor:pointer;"><a><i class="icon-fast-backward icon-white"></i></a></li>'+
							'<li onclick="play()" style="cursor:pointer;"><a><i class="icon-play icon-white"></i></a></li>'+
							'<li onclick="pause()" style="cursor:pointer;"><a><i class="icon-pause icon-white"></i></a></li>'+
							'<li onclick="stop()" style="cursor:pointer;"><a><i class="icon-stop icon-white"></i></a></li>'+
							'<li onclick="next()" style="cursor:pointer;"><a><i class="icon-fast-forward icon-white"></i></a></li>';
				$('#nav').html(navhtml);
				<!-- Update the Current Song -->
				update_nowplaying(station_port);
				songupdater = setInterval(function() {
					update_nowplaying(station_port)},2000);
				
				}
			);
		}

	
	function update_nowplaying(station_port) {
		$.getJSON('/nowplaying/',
		{'station_port' : station_port})
		.done(function(data) { 
			cur_artist = data.artist;
			cur_album = data.album;
			html = "<b>" + data.title + "</b><br><br>" +
				"<b>" + data.artist + "</b><br>" +
				data.album + " (" + data.date + ")<br><br>" +
				"<small>" +
				"Genre: " + data.genre + "<br>" +
				"Track: "+ data.track + "<br>" +
				"Length: " + data.time + "<br>" +
				"</small>";
			$("#trackinfo").html(html);
			
			$('#trackinfo').show();
			
			if (cur_album != last_album) { //if album changes
				$('#albumcovercontainer').html('<img src="{{STATIC_URL}}img/loading.gif" />');
				update_albumcover(cur_artist,cur_album);
			}
			if (last_artist != cur_artist) { //if album changes
				$('#artistinfo').html('<img src="{{STATIC_URL}}img/loading.gif" />');
				update_artistinfo(cur_artist);
			}
			last_artist = cur_artist;
			last_album = cur_album
		});
	}
	

	function update_chat() {
		
		$.getJSON("/ajaxchat/")
		.done(function(data) {
			var html = "";
			for (var i=0; i<data.length; i++) { 
				
				html = html + "<p></p><small><strong>" + data[i].author + "</strong><span class='muted'> " + 
					data[i].timestamp +  "</span><br>" +
					data[i].content + "</small></p>	";
			}
			$('#chat').html(html);
		});
	}
	

	function push_chat() {
		
		content = document.getElementById('chatcontent').value;
		$.post('/chatpush/',
		{'chat_content':content});
		$('#chatcontent').val("");
		update_chat()
		
	}
	
	
	
		<!-- for csrf token in ajax -->
	$(document).ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie != '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
    }
    function sameOrigin(url) {
		// url could be relative or scheme relative or absolute
		var host = document.location.host; // host + port
		var protocol = document.location.protocol;
		var sr_origin = '//' + host;
		var origin = protocol + sr_origin;
		// Allow absolute or scheme relative URLs to same origin
		return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
			(url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
			// or any other URL that isn't scheme relative or absolute i.e relative.
			!(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
		xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
	});
</script>
   
  {% endif %}

  </body>
</html>
